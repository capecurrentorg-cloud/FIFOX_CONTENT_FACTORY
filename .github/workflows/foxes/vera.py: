import anthropic
import os
import json

client = anthropic.Anthropic(api_key=os.environ.get("ANTHROPIC_API_KEY"))

# Load video metadata
with open('output/tiktok_video.json', 'r') as f:
    data = json.load(f)

# Verify content is appropriate
verification_prompt = f"""
Review this TikTok content for posting:

Script: {data['script']}
Video file: {data['video_file']}
Generated by: {data['generated_by']}

Check for:
1. Brand safety - appropriate for restaurants
2. Accuracy - no false claims
3. Compliance - no violations
4. Quality - engaging and professional

Return JSON with:
- approved: true/false
- issues: list of any problems
- confidence: 0-100
"""

message = client.messages.create(
    model="claude-sonnet-4-20250514",
    max_tokens=512,
    messages=[{
        "role": "user",
        "content": verification_prompt
    }]
)

verification = message.content[0].text

# Parse verification result
try:
    result = json.loads(verification)
    approved = result.get('approved', False)
except:
    approved = False
    result = {"approved": False, "issues": ["Verification parsing failed"]}

# Save verification
data['verification'] = result
data['approved'] = approved

with open('output/tiktok_final.json', 'w') as f:
    json.dump(data, f)

if approved:
    print("✓ VERA APPROVED - Content ready to post")
else:
    print(f"✗ VERA REJECTED - Issues: {result.get('issues')}")
    raise Exception("Content failed verification")